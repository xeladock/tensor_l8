у меня было несколько идей как реализовать кастомную метрику:

1)залить в контейнер nginx и через f=file заставить python делать >stdout из api кубера в /metrics

2)сделать python web-сервером и через entrypoint заставить его исполнять скрипт

3)сделать через модные фреймворки прометеуса

Я выбрал вариант 2. Потому что меньше слоёв в контейнере по сравнению с 1 и отсуствие времени на разбор def() из 3.


сам контейнер закоммичен сюда:
docker push xeladock/totalpods:latest

Собран на бубунту потому что library/ubuntu из коробки берёт самый свежий python3 (да, для меня это принципиально). Alpine пока так не умеет, поэтому если python, то бубунтуконтейнер.

на скриншотах из графаны number-pod-old-grafana.png и number-pod-new-grafana.png видно что общее число подов 24 (old) и 26(new). Сделано специально: между скринами был апнут контейнер для наглядности (replicas=2). Ну и скрин "prometheus-add-pods-graph" это показывает.

